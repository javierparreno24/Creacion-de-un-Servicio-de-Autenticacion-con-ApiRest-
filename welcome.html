<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Bienvenido</title>
</head>
<body>
    <h1 id="welcomeTitle">Cargando...</h1>
    <p id="userInfo"></p>
    <p id="currentTime"></p>
    <p id="extraMessage"></p>
    
    <button id="logoutButton">Cerrar Sesión</button>

    <script>
        const token = localStorage.getItem('authToken');
        
        if (!token) {
            // Si no hay token, redirige a "No tienes permisos" (Requerido)
            window.location.href = 'no-permisos.html';
        }

        async function loadWelcomeData() {
            try {
                // Petición al endpoint protegido, enviando el token en la cabecera (Requerido)
                const response = await fetch('api.php/api/welcome', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}` // Formato requerido
                    }
                });

                if (response.ok) { // 200 OK
                    const data = await response.json();
                    // Muestra los datos del usuario y la hora actual (Requerido)
                    document.getElementById('welcomeTitle').textContent = `¡Bienvenido, ${data.username}!`;
                    document.getElementById('userInfo').textContent = `Usuario autenticado: ${data.username}`;
                    document.getElementById('currentTime').textContent = `Hora actual del servidor: ${data.current_time}`;
                    document.getElementById('extraMessage').textContent = data.additional_welcome;
                } else if (response.status === 403) { // 403 Forbidden (Requerido)
                    // Token inválido o expirado, redirige a la página de error
                    window.location.href = 'no-permisos.html';
                } else {
                    alert('Error al obtener datos: ' + response.status);
                    // Por seguridad, si falla, eliminamos el token y volvemos al login
                    logout(); 
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                alert('Error de conexión o de red.');
                logout(); 
            }
        }

        function logout() {
            // Elimina el token almacenado en el cliente (Requerido)
            localStorage.removeItem('authToken'); 
            // Redirige al login (Requerido)
            window.location.href = 'index.html'; 
        }

        document.getElementById('logoutButton').addEventListener('click', logout);

        loadWelcomeData();
    </script>
</body>
</html>
